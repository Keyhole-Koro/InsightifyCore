%%{init: {'flowchart': {'htmlLabels': true}, 'themeVariables': {'fontSize': '14px'}}}%%
graph TD
  arch_design["<span style='font-size:16px;font-weight:600'>arch_design</span><br/><span style='font-size:12px'>LLM drafts initial architecture hypothesis from file index + Markdown docs and proposes next files to open.</span>"]
  code_graph["<span style='font-size:16px;font-weight:600'>code_graph</span><br/><span style='font-size:12px'>Normalize dependency hits into a DAG and drop weaker bidirectional edges.</span>"]
  code_imports["<span style='font-size:16px;font-weight:600'>code_imports</span><br/><span style='font-size:12px'>Word-index dependency sweep across source roots to collect possible file-level dependencies.</span>"]
  code_roots["<span style='font-size:16px;font-weight:600'>code_roots</span><br/><span style='font-size:12px'>Scan repo layout and ask LLM to classify main source roots, library/vendor roots, and config hotspots.</span>"]
  code_specs["<span style='font-size:16px;font-weight:600'>code_specs</span><br/><span style='font-size:12px'>LLM infers language families/import heuristics from extension counts and roots.</span>"]
  code_symbols["<span style='font-size:16px;font-weight:600'>code_symbols</span><br/><span style='font-size:12px'>LLM traverses tasks to build identifier reference maps (outgoing/incoming).</span>"]
  code_tasks["<span style='font-size:16px;font-weight:600'>code_tasks</span><br/><span style='font-size:12px'>Chunk graph nodes into LLM-sized tasks with token estimates per file.</span>"]
  infra_context["<span style='font-size:16px;font-weight:600'>infra_context</span><br/><span style='font-size:12px'>LLM summarizes external systems/infra using architecture (arch_design) + identifier refs (code_symbols), surfacing evidence gaps.</span>"]
  infra_refine["<span style='font-size:16px;font-weight:600'>infra_refine</span><br/><span style='font-size:12px'>LLM drills into evidence gaps from infra_context by opening targeted files/snippets.</span>"]

  code_roots --> arch_design
  code_imports --> code_graph
  code_specs --> code_imports
  code_roots --> code_imports
  code_roots --> code_specs
  code_tasks --> code_symbols
  code_graph --> code_tasks
  arch_design --> infra_context
  code_symbols --> infra_context
  code_roots --> infra_context
  infra_context --> infra_refine

